(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/chat/chat"],{221:function(t,e,n){"use strict";(function(t,e){var o=n(4);n(26);o(n(25));var i=o(n(222));t.__webpack_require_UNI_MP_PLUGIN__=n,e(i.default)}).call(this,n(1)["default"],n(2)["createPage"])},222:function(t,e,n){"use strict";n.r(e);var o=n(223),i=n(225);for(var a in i)["default"].indexOf(a)<0&&function(t){n.d(e,t,(function(){return i[t]}))}(a);n(227);var r,c=n(39),s=Object(c["default"])(i["default"],o["render"],o["staticRenderFns"],!1,null,"bf16e7f4",null,!1,o["components"],r);s.options.__file="pages/chat/chat.vue",e["default"]=s.exports},223:function(t,e,n){"use strict";n.r(e);var o=n(224);n.d(e,"render",(function(){return o["render"]})),n.d(e,"staticRenderFns",(function(){return o["staticRenderFns"]})),n.d(e,"recyclableRender",(function(){return o["recyclableRender"]})),n.d(e,"components",(function(){return o["components"]}))},224:function(t,e,n){"use strict";var o;n.r(e),n.d(e,"render",(function(){return i})),n.d(e,"staticRenderFns",(function(){return r})),n.d(e,"recyclableRender",(function(){return a})),n.d(e,"components",(function(){return o}));try{o={uPopup:function(){return Promise.all([n.e("common/vendor"),n.e("uni_modules/uview-ui/components/u-popup/u-popup")]).then(n.bind(null,310))},uIcon:function(){return Promise.all([n.e("common/vendor"),n.e("uni_modules/uview-ui/components/u-icon/u-icon")]).then(n.bind(null,301))},uRate:function(){return Promise.all([n.e("common/vendor"),n.e("uni_modules/uview-ui/components/u-rate/u-rate")]).then(n.bind(null,318))},"u-Textarea":function(){return Promise.all([n.e("common/vendor"),n.e("uni_modules/uview-ui/components/u--textarea/u--textarea")]).then(n.bind(null,326))}}}catch(c){if(-1===c.message.indexOf("Cannot find module")||-1===c.message.indexOf(".vue"))throw c;console.error(c.message),console.error("1. 排查组件名称拼写是否正确"),console.error("2. 排查组件是否符合 easycom 规范，文档：https://uniapp.dcloud.net.cn/collocation/pages?id=easycom"),console.error("3. 若组件不符合 easycom 规范，需手动引入，并在 components 中注册该组件")}var i=function(){var t=this,e=t.$createElement,n=(t._self._c,t.text.length),o="emoticon"===t.mode||"action"===t.mode?t.emoticonOrActionList.length:null;t._isMounted||(t.e0=function(e){t.evaluateShow=!0},t.e1=function(e){t.evaluateShow=!1}),t.$mp.data=Object.assign({},{$root:{g0:n,g1:o}})},a=!1,r=[];i._withStripped=!0},225:function(t,e,n){"use strict";n.r(e);var o=n(226),i=n.n(o);for(var a in o)["default"].indexOf(a)<0&&function(t){n.d(e,t,(function(){return o[t]}))}(a);e["default"]=i.a},226:function(t,e,n){"use strict";(function(t){var o=n(4);Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i=o(n(31)),a=o(n(33)),r=o(n(11)),c=n(164);function s(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,o)}return n}function u(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?s(Object(n),!0).forEach((function(e){(0,r.default)(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var d=function(){n.e("components/free-ui/free-icon-button").then(function(){return resolve(n(332))}.bind(null,n)).catch(n.oe)},h=function(){Promise.all([n.e("common/vendor"),n.e("components/free-ui/free-chat-item")]).then(function(){return resolve(n(337))}.bind(null,n)).catch(n.oe)},f=function(){n.e("components/free-ui/free-popup").then(function(){return resolve(n(345))}.bind(null,n)).catch(n.oe)},l=function(){n.e("components/free-ui/free-main-button").then(function(){return resolve(n(352))}.bind(null,n)).catch(n.oe)},p={components:{freeIconButton:d,freeChatItem:h,freePopup:f,freeMainButton:l},data:function(){return{value1:"",guwen:{count:5,value:5},lvshi:{count:5,value:5},evaluateShow:!1,scrollIntoView:"",mode:"text",actionList:[[{name:"相册",icon:"/static/images/extends/pic.png",event:"uploadImage"}]],emoticonList:[],KeyboardHeight:0,menusList:[],navBarHeight:0,list:[],propIndex:-1,text:"",isRecording:!1,RecordingStartY:0,unRecord:!1,detail:{id:0,name:"",avatar:"",chat_type:"user"},isfocus:!1}},mounted:function(){var e=this,n=0;this.navBarHeight=n+t.upx2px(90),this.regSendVoiceEvent((function(n){e.unRecord||(console.log(e.RecordTime,n),e.RecordTime>0?e.$http.upLoadFile(n).then((function(t){e.send("3",t.data.url,{time:e.RecordTime})})):t.showToast({title:"录音时间太短",icon:"none"}))})),this.pageToBottom()},computed:u(u({},(0,c.mapState)({RECORD:function(t){return t.audio.RECORD},RecordTime:function(t){return t.audio.RecordTime},chatList:function(t){return t.chatList},chat:function(t){return t.chat},totalNoreadnum:function(t){return t.totalNoreadnum},user:function(t){return t.userInfo},KeyboardH:function(t){return t.KeyboardHeight}})),{},{currentChatItem:function(){var t=this,e=this.chatList.findIndex((function(e){return e.id===t.detail.id&&e.chat_type===t.detail.chat_type}));return-1!==e?this.chatList[e]:{}},maskBottom:function(){var e="emoticon"==this.mode||"action"==this.mode?t.upx2px(685):t.upx2px(105);return this.isfocus&&(e=this.KeyboardHeight+t.upx2px(105)),e},getMenusHeight:function(){var t=100;return this.menusList.length*t},getMenusStyle:function(){return"height: ".concat(this.getMenusHeight,"rpx;")},isdoSelf:function(){var t=1,e=this.propIndex>-1?this.list[this.propIndex].user_id:0;return e===t},chatBodyBottom:function(){var e="emoticon"==this.mode||"action"==this.mode?t.upx2px(685):t.upx2px(105);return this.isfocus&&(e=this.KeyboardHeight+t.upx2px(105)),"bottom:".concat(e,"px;top:0px;")},emoticonOrActionList:function(){return"emoticon"===this.mode||"action"===this.mode?this[this.mode+"List"]:[]},imageList:function(){var t=[];return this.list.forEach((function(e){"emoticon"!==e.type&&"2"!=e.type||t.push(e.data)})),t}}),watch:{mode:function(e,n){"text"!==e&&(this.KeyboardHeight=0,this.isfocus=!1,t.hideKeyboard())},KeyboardH:function(t,e){this.KeyboardHeight=t,t>0&&(this.mode="text")}},onLoad:function(e){var n=this;return(0,a.default)(i.default.mark((function o(){var a,r,c;return i.default.wrap((function(o){while(1)switch(o.prev=o.next){case 0:if(e.params){o.next=2;break}return o.abrupt("return");case 2:return n.detail=JSON.parse(decodeURIComponent(e.params)),n.__init(),n.chat.createChatObject(n.detail),o.next=7,n.chat.getChatDetail(!1,n.detail.chatRoomNumber);case 7:a=o.sent,r=[],c=[],a.rows.forEach((function(t){c.push(JSON.parse(t.text))})),r=c.reverse().concat(r),n.list=r,t.$on("onMessage",n.onMessage),t.$on("updateHistory",n.updateHistory),t.$on("sendItem",n.onSendItem);case 15:case"end":return o.stop()}}),o)})))()},destroyed:function(){this.voiceTouchEnd(),this.chat.destoryChatObject(),t.$off("onMessage",this.onMessage),t.$off("updateHistory",this.updateHistory),t.$off("sendItem",this.onSendItem)},methods:u(u({},(0,c.mapMutations)(["regSendVoiceEvent"])),{},{subStar:function(){var e=this;return(0,a.default)(i.default.mark((function n(){var o;return i.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.next=2,e.$http.star({platformType:0,starUserId:e.detail.to_id,star:e.guwen.value,text:e.value1});case 2:o=n.sent,200==o.code?(t.showToast({title:"感谢你的评价",icon:"none"}),e.close()):t.showToast({title:o.msg,icon:"none"});case 4:case"end":return n.stop()}}),n)})))()},close:function(){this.evaluateShow=!1},open:function(){this.evaluateShow=!0},onSendItem:function(t){"fava"!==t.sendType&&"card"!==t.sendType||this.send(t.type,t.data,t.options)},updateHistory:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.list=t?[]:this.chat.getChatDetail()},onMessage:function(t){if(console.log("[聊天页] 监听接收聊天信息",t),t.from_id===this.detail.to_id&&1==t.chat_type||"group"===t.chat_type&&t.to_id===this.detail.to_id){if(1!==t.isremove)return this.list.push(t),this.pageToBottom();var e=this.list.findIndex((function(e){return e.id===t.id}));-1!==e&&(this.list[e].isremove=1)}},__init:function(){for(var t=20,e=Math.ceil(t/8),n=[],o=0;o<e;o++){var i=8*o;n[o]=[];for(var a=0;a<8;a++){var r=i+a;r+1>t||n[o].push({name:"表情"+r,icon:"/static/images/emoticon/5497/"+r+".gif",event:"sendEmoticon"})}}n=[[{name:"表情0",icon:"/static/images/emoticon/5497/0.gif",event:"sendEmoticon"}]],this.emoticonList=n,this.chat.initChatListItem({chat_type:this.detail.chat_type,to_id:this.detail.id,to_name:this.detail.name,to_avatar:this.detail.avatar,data:1==this.detail.chat_type?"你们已经是好友，可以开始聊天了":"你已经加入群聊，可以开始聊天了"})},openActionOrEmoticon:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"action";this.mode=e,t.hideKeyboard()},send:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};switch(t){case 1:n=n||this.text;break}var i=this.chat.formatSendData({type:t,data:n,options:o}),a=this.list.length;this.list.push(i);var r=!1;1==i.type||"emoticon"===i.type||"card"===i.type||i.data.startsWith("http")||(r=function(t){}),this.chat.send(i,r,this.detail.chatRoomNumber).then((function(t){e.list[a].id=t.id,e.list[a].sendStatus="success"})).catch((function(t){e.list[a].sendStatus="fail"})),1==t&&(this.text=""),this.pageToBottom()},pageToBottom:function(){var t=this;setTimeout((function(){var e=t.list.length-1;t.scrollIntoView="chatItem_"+e}),300)},long:function(t){var e=t.x,n=t.y,o=t.index;this.propIndex=o;var i=[{name:"发送给朋友",event:"sendToChatItem"},{name:"收藏",event:"fava"},{name:"删除",event:"delete"}],a=this.list[this.propIndex],r=this.user.id===a.from_id;r&&i.push({name:"撤回",event:"removeChatItem"}),1==a.type&&i.unshift({name:"复制",event:"copy"}),this.menusList=i,this.$refs.extend.show(e,n)},clickEvent:function(e){var n=this,o=this.list[this.propIndex],i=this.user.id===o.from_id;switch(e){case"removeChatItem":this.chat.recall(o).then((function(t){o.isremove=1}));break;case"sendToChatItem":t.navigateTo({url:"../chat-list/chat-list?params="+encodeURIComponent(JSON.stringify(o))});break;case"copy":t.setClipboardData({data:o.data,success:function(){t.showToast({title:"复制成功",icon:"none"})}});break;case"delete":t.showModal({content:"是否要删除该记录？",success:function(t){t.confirm&&(n.chat.deleteChatDetailItem(o,i),n.list.splice(n.propIndex,1),n.list.length===n.propIndex&&n.chat.updateChatItem({id:n.detail.id,chat_type:n.detail.chat_type},(function(t){var e=n.list[n.propIndex-1],o="";return e&&(o=n.chat.formatChatItemData(e,i)),t.data=o,t})))}});break;case"fava":t.showModal({content:"是否要加入收藏？",success:function(t){t.confirm}});break}this.$refs.extend.hide()},actionEvent:function(e){var n=this,o=this;switch(e.event){case"uploadImage":t.chooseImage({count:9,success:function(t){t.tempFilePaths.forEach((function(t){o.$http.upLoadFile(t).then((function(t){n.send("2",t.data.url)}))}))}});break;case"uploadVideo":t.chooseVideo({maxDuration:10,success:function(t){n.send("video",t.tempFilePath)}});break;case"sendEmoticon":this.send("emoticon",e.icon);break;case"openFava":t.navigateTo({url:"../../my/fava/fava?type=send"});break;case"sendCard":t.navigateTo({url:"../../mail/mail/mail?type=sendCard&limit=1"});break}},clickPage:function(){this.mode=""},previewImage:function(e){t.previewImage({current:e,urls:this.imageList,indicator:"default"})},changeVoiceOrText:function(){this.mode="audio"!==this.mode?"audio":"1"},voiceTouchStart:function(t){var e=this;return(0,a.default)(i.default.mark((function n(){return i.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:console.log(e.RECORD),e.isRecording=!0,e.RecordingStartY=t.changedTouches[0].screenY,e.unRecord=!1,e.RECORD.start({format:"mp3"});case 5:case"end":return n.stop()}}),n)})))()},voiceTouchEnd:function(){var t=this;return(0,a.default)(i.default.mark((function e(){return i.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:setTimeout((function(){t.RECORD.stop()}),300),t.isRecording=!1;case 2:case"end":return e.stop()}}),e)})))()},voiceTouchCancel:function(){var t=this;return(0,a.default)(i.default.mark((function e(){return i.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:setTimeout((function(){t.RECORD.stop()}),300),t.isRecording=!1,t.unRecord=!0;case 3:case"end":return e.stop()}}),e)})))()},voiceTouchMove:function(t){var e=Math.abs(t.changedTouches[0].screenY-this.RecordingStartY);this.unRecord=e>=50},openChatSet:function(){t.navigateTo({url:"../chat-set/chat-set?params="+JSON.stringify({id:this.detail.id,chat_type:this.detail.chat_type})})},focus:function(t){this.mode="1",this.isfocus=!0,this.KeyboardHeight=t.detail.height},blur:function(){this.KeyboardHeight=0,this.isfocus=!1}})};e.default=p}).call(this,n(2)["default"])},227:function(t,e,n){"use strict";n.r(e);var o=n(228),i=n.n(o);for(var a in o)["default"].indexOf(a)<0&&function(t){n.d(e,t,(function(){return o[t]}))}(a);e["default"]=i.a},228:function(t,e,n){}},[[221,"common/runtime","common/vendor"]]]);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/chat/chat.js.map