(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/chat/chat"],{212:function(t,e,n){"use strict";(function(t,e){var i=n(4);n(26);i(n(25));var o=i(n(213));t.__webpack_require_UNI_MP_PLUGIN__=n,e(o.default)}).call(this,n(1)["default"],n(2)["createPage"])},213:function(t,e,n){"use strict";n.r(e);var i=n(214),o=n(216);for(var a in o)["default"].indexOf(a)<0&&function(t){n.d(e,t,(function(){return o[t]}))}(a);var s,c=n(39),r=Object(c["default"])(o["default"],i["render"],i["staticRenderFns"],!1,null,null,null,!1,i["components"],s);r.options.__file="pages/chat/chat.vue",e["default"]=r.exports},214:function(t,e,n){"use strict";n.r(e);var i=n(215);n.d(e,"render",(function(){return i["render"]})),n.d(e,"staticRenderFns",(function(){return i["staticRenderFns"]})),n.d(e,"recyclableRender",(function(){return i["recyclableRender"]})),n.d(e,"components",(function(){return i["components"]}))},215:function(t,e,n){"use strict";var i;n.r(e),n.d(e,"render",(function(){return o})),n.d(e,"staticRenderFns",(function(){return s})),n.d(e,"recyclableRender",(function(){return a})),n.d(e,"components",(function(){return i}));var o=function(){var t=this,e=t.$createElement,n=(t._self._c,t.text.length),i="emoticon"===t.mode||"action"===t.mode?t.emoticonOrActionList.length:null;t.$mp.data=Object.assign({},{$root:{g0:n,g1:i}})},a=!1,s=[];o._withStripped=!0},216:function(t,e,n){"use strict";n.r(e);var i=n(217),o=n.n(i);for(var a in i)["default"].indexOf(a)<0&&function(t){n.d(e,t,(function(){return i[t]}))}(a);e["default"]=o.a},217:function(t,e,n){"use strict";(function(t){var i=n(4);Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var o=i(n(31)),a=i(n(33)),s=i(n(11)),c=n(164);function r(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function u(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?r(Object(n),!0).forEach((function(e){(0,s.default)(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var d=function(){n.e("components/free-ui/free-icon-button").then(function(){return resolve(n(280))}.bind(null,n)).catch(n.oe)},h=function(){Promise.all([n.e("common/vendor"),n.e("components/free-ui/free-chat-item")]).then(function(){return resolve(n(285))}.bind(null,n)).catch(n.oe)},f=function(){n.e("components/free-ui/free-popup").then(function(){return resolve(n(293))}.bind(null,n)).catch(n.oe)},l=function(){n.e("components/free-ui/free-main-button").then(function(){return resolve(n(300))}.bind(null,n)).catch(n.oe)},p={components:{freeIconButton:d,freeChatItem:h,freePopup:f,freeMainButton:l},data:function(){return{scrollIntoView:"",mode:"text",actionList:[[{name:"相册",icon:"/static/images/extends/pic.png",event:"uploadImage"},{name:"拍摄",icon:"/static/images/extends/video.png",event:"uploadVideo"},{name:"收藏",icon:"/static/images/extends/shoucan.png",event:"openFava"},{name:"名片",icon:"/static/images/extends/man.png",event:"sendCard"},{name:"语音通话",icon:"/static/images/extends/phone.png",event:""},{name:"位置",icon:"/static/images/extends/path.png",event:""}]],emoticonList:[],KeyboardHeight:0,menusList:[],navBarHeight:0,list:[],propIndex:-1,text:"",isRecording:!1,RecordingStartY:0,unRecord:!1,detail:{id:0,name:"",avatar:"",chat_type:"user"},isfocus:!1}},mounted:function(){var e=this,n=0;this.navBarHeight=n+t.upx2px(90),this.regSendVoiceEvent((function(n){e.unRecord||(e.RecordTime>0?e.send("audio",n,{time:e.RecordTime}):t.showToast({title:"录音时间太短",icon:"none"}))})),this.pageToBottom()},computed:u(u({},(0,c.mapState)({chatList:function(t){return t.chatList},chat:function(t){return t.chat},totalNoreadnum:function(t){return t.totalNoreadnum},user:function(t){return t.userInfo},KeyboardH:function(t){return t.KeyboardHeight}})),{},{currentChatItem:function(){var t=this,e=this.chatList.findIndex((function(e){return e.id===t.detail.id&&e.chat_type===t.detail.chat_type}));return-1!==e?this.chatList[e]:{}},maskBottom:function(){var e="emoticon"==this.mode||"action"==this.mode?t.upx2px(685):t.upx2px(105);return this.isfocus&&(e=this.KeyboardHeight+t.upx2px(105)),e},getMenusHeight:function(){var t=100;return this.menusList.length*t},getMenusStyle:function(){return"height: ".concat(this.getMenusHeight,"rpx;")},isdoSelf:function(){var t=1,e=this.propIndex>-1?this.list[this.propIndex].user_id:0;return e===t},chatBodyBottom:function(){var e="emoticon"==this.mode||"action"==this.mode?t.upx2px(685):t.upx2px(105);return this.isfocus&&(e=this.KeyboardHeight+t.upx2px(105)),"bottom:".concat(e,"px;top:").concat(this.navBarHeight,"px;")},emoticonOrActionList:function(){return"emoticon"===this.mode||"action"===this.mode?this[this.mode+"List"]:[]},imageList:function(){var t=[];return this.list.forEach((function(e){"emoticon"!==e.type&&"image"!==e.type||t.push(e.data)})),t}}),watch:{mode:function(e,n){"text"!==e&&(this.KeyboardHeight=0,this.isfocus=!1,t.hideKeyboard())},KeyboardH:function(t,e){this.KeyboardHeight=t,t>0&&(this.mode="text")}},onLoad:function(e){if(!e.params)return this.backToast();this.detail=JSON.parse(decodeURIComponent(e.params)),console.log(this.detail),this.__init(),this.chat.createChatObject(this.detail),this.list=this.chat.getChatDetail(!1,this.detail.chatRoomNumber),t.$on("onMessage",this.onMessage),t.$on("updateHistory",this.updateHistory),t.$on("sendItem",this.onSendItem)},destroyed:function(){this.voiceTouchEnd(),this.chat.destoryChatObject(),t.$off("onMessage",this.onMessage),t.$off("updateHistory",this.updateHistory),t.$off("sendItem",this.onSendItem)},methods:u(u({},(0,c.mapMutations)(["regSendVoiceEvent"])),{},{backToast:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"非法参数";t.showToast({title:e,icon:"none"}),t.navigateBack({delta:1})},onSendItem:function(t){"fava"!==t.sendType&&"card"!==t.sendType||this.send(t.type,t.data,t.options)},updateHistory:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.list=t?[]:this.chat.getChatDetail()},onMessage:function(t){if(t.from_id===this.detail.id&&"user"===t.chat_type||"group"===t.chat_type&&t.to_id===this.detail.id){if(1!==t.isremove)return this.list.push(t),this.pageToBottom();var e=this.list.findIndex((function(e){return e.id===t.id}));-1!==e&&(this.list[e].isremove=1)}},__init:function(){for(var t=20,e=Math.ceil(t/8),n=[],i=0;i<e;i++){var o=8*i;n[i]=[];for(var a=0;a<8;a++){var s=o+a;s+1>t||n[i].push({name:"表情"+s,icon:"/static/images/emoticon/5497/"+s+".gif",event:"sendEmoticon"})}}this.emoticonList=n,this.chat.initChatListItem({chat_type:this.detail.chat_type,to_id:this.detail.id,to_name:this.detail.name,to_avatar:this.detail.avatar,data:"user"===this.detail.chat_type?"你们已经是好友，可以开始聊天了":"你已经加入群聊，可以开始聊天了"})},openActionOrEmoticon:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"action";this.mode=e,t.hideKeyboard()},send:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};switch(t){case"text":n=n||this.text;break}var o=this.chat.formatSendData({type:t,data:n,options:i}),a=this.list.length;this.list.push(o);var s=!1;"text"===o.type||"emoticon"===o.type||"card"===o.type||o.data.startsWith("http")||(s=function(t){}),this.chat.send(o,s,this.detail.chatRoomNumber).then((function(t){e.list[a].id=t.id,e.list[a].sendStatus="success"})).catch((function(t){e.list[a].sendStatus="fail"})),"text"===t&&(this.text=""),this.pageToBottom()},pageToBottom:function(){var t=this;setTimeout((function(){var e=t.list.length-1;t.scrollIntoView="chatItem_"+e}),300)},long:function(t){var e=t.x,n=t.y,i=t.index;this.propIndex=i;var o=[{name:"发送给朋友",event:"sendToChatItem"},{name:"收藏",event:"fava"},{name:"删除",event:"delete"}],a=this.list[this.propIndex],s=this.user.id===a.from_id;s&&o.push({name:"撤回",event:"removeChatItem"}),"text"===a.type&&o.unshift({name:"复制",event:"copy"}),this.menusList=o,this.$refs.extend.show(e,n)},clickEvent:function(e){var n=this,i=this.list[this.propIndex],o=this.user.id===i.from_id;switch(e){case"removeChatItem":this.chat.recall(i).then((function(t){i.isremove=1}));break;case"sendToChatItem":t.navigateTo({url:"../chat-list/chat-list?params="+encodeURIComponent(JSON.stringify(i))});break;case"copy":t.setClipboardData({data:i.data,success:function(){t.showToast({title:"复制成功",icon:"none"})}});break;case"delete":t.showModal({content:"是否要删除该记录？",success:function(t){t.confirm&&(n.chat.deleteChatDetailItem(i,o),n.list.splice(n.propIndex,1),n.list.length===n.propIndex&&n.chat.updateChatItem({id:n.detail.id,chat_type:n.detail.chat_type},(function(t){var e=n.list[n.propIndex-1],i="";return e&&(i=n.chat.formatChatItemData(e,o)),t.data=i,t})))}});break;case"fava":t.showModal({content:"是否要加入收藏？",success:function(t){t.confirm}});break}this.$refs.extend.hide()},actionEvent:function(e){var n=this;switch(e.event){case"uploadImage":t.chooseImage({count:9,success:function(t){console.log(t),t.tempFilePaths.forEach((function(t){n.send("image",t)}))}});break;case"uploadVideo":t.chooseVideo({maxDuration:10,success:function(t){n.send("video",t.tempFilePath)}});break;case"sendEmoticon":this.send("emoticon",e.icon);break;case"openFava":t.navigateTo({url:"../../my/fava/fava?type=send"});break;case"sendCard":t.navigateTo({url:"../../mail/mail/mail?type=sendCard&limit=1"});break}},clickPage:function(){this.mode=""},previewImage:function(e){t.previewImage({current:e,urls:this.imageList,indicator:"default"})},changeVoiceOrText:function(){this.mode="audio"!==this.mode?"audio":"text"},voiceTouchStart:function(t){var e=this;return(0,a.default)(o.default.mark((function n(){return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:e.isRecording=!0,e.RecordingStartY=t.changedTouches[0].screenY,e.unRecord=!1,e.RECORD.start({format:"mp3"});case 4:case"end":return n.stop()}}),n)})))()},voiceTouchEnd:function(){var t=this;return(0,a.default)(o.default.mark((function e(){return o.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:setTimeout((function(){t.RECORD.stop()}),300),t.isRecording=!1;case 2:case"end":return e.stop()}}),e)})))()},voiceTouchCancel:function(){var t=this;return(0,a.default)(o.default.mark((function e(){return o.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:setTimeout((function(){t.RECORD.stop()}),300),t.isRecording=!1,t.unRecord=!0;case 3:case"end":return e.stop()}}),e)})))()},voiceTouchMove:function(t){var e=Math.abs(t.changedTouches[0].screenY-this.RecordingStartY);this.unRecord=e>=50},openChatSet:function(){t.navigateTo({url:"../chat-set/chat-set?params="+JSON.stringify({id:this.detail.id,chat_type:this.detail.chat_type})})},focus:function(t){this.mode="text",this.isfocus=!0,this.KeyboardHeight=t.detail.height},blur:function(){this.KeyboardHeight=0,this.isfocus=!1}})};e.default=p}).call(this,n(2)["default"])}},[[212,"common/runtime","common/vendor"]]]);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/chat/chat.js.map